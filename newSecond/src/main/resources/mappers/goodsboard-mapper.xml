<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="goodsBoardMapper">

	<resultMap type="GoodsBoard" id="goodsboard_rm">
		<!-- DB의 기본 키(복합키면 여러 개 작성) -->
		<id property="goodsNo" column="GOODS_NO" />
		
		<!-- DB의 일반 컬럼들 -->
		<result property="userNo" column="USER_NO" />
		<result property="categoryNo" column="CATEGORY_NO" />
		<result property="goodsTitle" column="GOODS_TITLE" />
		<result property="goodsDescr" column="GOODS_DESCR" />
		<result property="goodsPrice" column="GOODS_PRICE" />
		<result property="viewCount" column="VIEW_COUNT" />
		<result property="wishCount" column="WISH_COUNT" />
		<result property="sellEnrollDate" column="SELL_ENROLL_DT" />
		<result property="goodsStatus" column="GOODS_STATUS" />
		
		<result property="thumbnail" column="THUMBNAIL" />
		
		<result property="shopTitle" column="SHOP_TITLE" />
		
	</resultMap>
	
	<!-- 유민 : (관리자 페이지 - 게시글 관리) -->
	
	
	
	<!-- 희진 : 상점 내 특정 유저 게시글 목록 -->
	<!-- 상품 게시글 목록 조회 -->
	<select id="selectGoodsBoardList" resultMap="goodsboard_rm" >
		SELECT USER_NO, CATEGORY_NO, GOODS_TITLE, GOODS_DESCR, GOODS_PRICE, 
				VIEW_COUNT, WISH_COUNT, GOODS_STATUS,
				
				<![CDATA[
		    CASE
		        WHEN SYSDATE - SELL_ENROLL_DT < 1/24/60 THEN FLOOR((SYSDATE - SELL_ENROLL_DT) * 24 * 60 * 60) || '초 전'
		        WHEN SYSDATE - SELL_ENROLL_DT < 1/24 THEN FLOOR((SYSDATE - SELL_ENROLL_DT) * 24 * 60) || '분 전'
		        WHEN SYSDATE - SELL_ENROLL_DT < 1 THEN FLOOR((SYSDATE - SELL_ENROLL_DT) * 24) || '시간 전'
		        WHEN SYSDATE - SELL_ENROLL_DT < 30 THEN FLOOR(SYSDATE - SELL_ENROLL_DT) || '일 전'
		        WHEN SYSDATE - SELL_ENROLL_DT < 365 THEN FLOOR((SYSDATE - SELL_ENROLL_DT) / 30) || '달 전'
		        ELSE FLOOR((SYSDATE - SELL_ENROLL_DT) / 365) || '년 전'
		    END SELL_ENROLL_DT, 
		    ]]>
		    
		    THUMBNAIL
		    
		FROM (SELECT USER_NO, CATEGORY_NO, GOODS_TITLE, GOODS_DESCR, GOODS_PRICE, 
				VIEW_COUNT, WISH_COUNT, GOODS_STATUS, SELL_ENROLL_DT, 
				NVL((SELECT FILE_PATH||USER_NO||'/'||FILE_NAME FROM "files" F
					WHERE F.GOODS_NO = G.GOODS_NO
					AND FILE_ORDER = 1), '/resources/src/img/basic_profile.png') THUMBNAIL 
				FROM "goods_board" G
				WHERE USER_NO = #{userNo}
				AND GOODS_STATUS NOT IN('D', 'B')
				ORDER BY GOODS_STATUS, SELL_ENROLL_DT DESC)
	</select>
	
	
	
	<!-- 지영 : 검색으로 상품 조회 -->
	<!-- 상품 게시글 수 카운트   -->
	<select id="searchGoodsCount" resultType="_int">
		SELECT COUNT(*)
		FROM "goods_board"
		JOIN "shop" USING (USER_NO)
		WHERE GOODS_STATUS IN ('A','E','R')
			AND ((GOODS_TITLE || GOODS_DESCR) LIKE '%${searchName}%'
			OR SHOP_TITLE LIKE '%${searchName}%')
		ORDER BY SELL_ENROLL_DT DESC
	</select>
	
	
	<!-- 검색 상품 목록 조회 -->
	<select id="selectSearchGoodsList" resultMap="goodsboard_rm">
	
		SELECT GOODS_NO , USER_NO , CATEGORY_NO , GOODS_TITLE , GOODS_PRICE,
			(SELECT FILE_PATH||USER_NO||'/'||FILE_NAME FROM "files" F
			WHERE F.GOODS_NO = G.GOODS_NO
			AND FILE_ORDER = 1) THUMBNAIL
		FROM "goods_board" G
		JOIN "shop" USING (USER_NO)
		WHERE GOODS_STATUS IN ('A','E','C')
			AND (GOODS_TITLE || GOODS_DESCR) LIKE '%${searchName}%'
		ORDER BY SELL_ENROLL_DT DESC
		
	</select>
		
		
		
		
</mapper>
